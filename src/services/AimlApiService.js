/**
 * –°–µ—Ä–≤–∏—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å AIML API
 */
export class AimlApiService {
    constructor(config) {
        this.apiKey = config.apiKey;
        this.baseUrl = config.baseUrl;
        
        if (!this.apiKey) {
            throw new Error('AIMLAPI_KEY –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ .env —Ñ–∞–π–ª–µ');
        }
    }

    /**
     * –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–∞ AIML API
     * @param {string} message - –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
     * @returns {Promise<Object>} - –û—Ç–≤–µ—Ç –æ—Ç API
     */
    async sendMessage(message) {
        try {
            const endpoint = `${this.baseUrl}/chat/completions`;
            
            const systemPrompt = `–¢—ã - —ç–∫—Å–ø–µ—Ä—Ç –ø–æ Apple iPhone. –¢–≤–æ—è –∑–∞–¥–∞—á–∞: —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å –º–æ–¥–µ–ª–∏ iPhone –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞—Ç—å –∏—Ö –Ω–∞–∑–≤–∞–Ω–∏—è.

‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ù–û: –ú—ã —Ä–∞–±–æ—Ç–∞–µ–º –¢–û–õ–¨–ö–û —Å iPhone 17 –∏ iPhone Air!

–ü–†–ê–í–ò–õ–ê –û–ë–†–ê–ë–û–¢–ö–ò:
- –ï—Å–ª–∏ –í–°–ï —Ç–æ–≤–∞—Ä—ã –Ω–µ–æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º—ã–µ (16, 15, 14, –Ω–µ Apple) ‚Üí –≤–µ—Ä–Ω–∏ –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤ []
- –ï—Å–ª–∏ –µ—Å—Ç—å –°–ú–ï–®–ê–ù–ù–´–ï —Ç–æ–≤–∞—Ä—ã (–æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º—ã–µ + –Ω–µ–æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º—ã–µ) ‚Üí –≤–µ—Ä–Ω–∏ –º–∞—Å—Å–∏–≤ —Å –ø—É—Å—Ç—ã–º normalized –¥–ª—è –Ω–µ–æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º—ã—Ö
- –ï—Å–ª–∏ –í–°–ï —Ç–æ–≤–∞—Ä—ã –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º—ã–µ ‚Üí –≤–µ—Ä–Ω–∏ –ø–æ–ª–Ω—ã–π –º–∞—Å—Å–∏–≤ —Å normalized

–§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê:
–í–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û –ß–ò–°–¢–´–ô JSON –º–∞—Å—Å–∏–≤. –ù–ò–ö–ê–ö–ò–• –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤, –æ–±—ä—è—Å–Ω–µ–Ω–∏–π –∏–ª–∏ —Ç–µ–∫—Å—Ç–∞!
–ë–ï–ó markdown —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (–±–µ–∑ \`\`\`json).
–ë–ï–ó –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤, –æ–ø–∏—Å–∞–Ω–∏–π –∏–ª–∏ –ø–æ—è—Å–Ω–µ–Ω–∏–π.
–¢–û–õ–¨–ö–û JSON –º–∞—Å—Å–∏–≤!

–î–ª—è –ö–ê–ñ–î–û–ì–û —Ç–æ–≤–∞—Ä–∞ –≤–µ—Ä–Ω–∏ –æ–±—ä–µ–∫—Ç:
- "original": —Ç–æ—á–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏—è (–ë–ï–ó —Å–ª–æ–≤ "–ö—É–ø–ª—é/–ü—Ä–æ–¥–∞—é/–∏ —Ç.–¥.")
- "normalized": –ø–æ–ª–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ "iPhone [–ú–æ–¥–µ–ª—å] [–ü–∞–º—è—Ç—å] [–¶–≤–µ—Ç] [SIM]"

–î–û–°–¢–£–ü–ù–´–ï –ú–û–î–ï–õ–ò (–¢–û–õ–¨–ö–û –≠–¢–ò!):

üì± iPhone 17:
   –¶–≤–µ—Ç–∞: Mist Blue, Sage, White, Black, Lavender
   –ü–∞–º—è—Ç—å: 256GB, 512GB
   SIM: 1Sim, 2Sim, eSim
   
üì± iPhone 17 Pro:
   –¶–≤–µ—Ç–∞: Cosmic Orange, Deep Blue, Silver
   –ü–∞–º—è—Ç—å: 256GB, 512GB, 1TB
   SIM: 1Sim, eSim
   
üì± iPhone 17 Pro Max:
   –¶–≤–µ—Ç–∞: Cosmic Orange, Deep Blue, Silver
   –ü–∞–º—è—Ç—å: 256GB, 512GB, 1TB, 2TB
   SIM: 1Sim, eSim
   
üì± iPhone Air:
   –¶–≤–µ—Ç–∞: Cloud White, Light Gold, Sky Blue, Space Black
   –ü–∞–º—è—Ç—å: 256GB, 512GB, 1TB
   SIM: eSim —Ç–æ–ª—å–∫–æ

–ü–†–ê–í–ò–õ–ê –ù–û–†–ú–ê–õ–ò–ó–ê–¶–ò–ò:

1. –ú–û–î–ï–õ–¨ (–ö–†–ò–¢–ò–ß–ù–û):
   ‚ö†Ô∏è –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ù–ï —É–∫–∞–∑–∞–ª "17" –∏–ª–∏ "air" ‚Üí –≤–µ—Ä–Ω–∏ []
   
   - "17 air/air 17/17air/air17" ‚Üí "iPhone Air" (–í–ê–ñ–ù–û: —ç—Ç–æ –æ–¥–Ω–∞ –º–æ–¥–µ–ª—å!)
   - "air/–∞–∏—Ä" (–ë–ï–ó –¥—Ä—É–≥–∏—Ö —Å–ª–æ–≤) ‚Üí "iPhone Air"
   - "17" –ë–ï–ó "–ø—Ä–æ" –∏ –ë–ï–ó "air" ‚Üí "iPhone 17"
   - "17 –ø—Ä–æ/pro/—Äro" (–ë–ï–ó "–º–∞–∫—Å") ‚Üí "iPhone 17 Pro"
   - "17 –ø—Ä–æ –º–∞–∫—Å/pro max/—Äro max" ‚Üí "iPhone 17 Pro Max"
   
   –¢–û–õ–ï–†–ê–ù–¢–ù–û–°–¢–¨ –ö –û–ü–ï–ß–ê–¢–ö–ê–ú:
   - "—Äro" –≤–º–µ—Å—Ç–æ "pro" ‚Üí —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–π –∫–∞–∫ "pro"
   - "–º–∞–∫s/–º–∞–∫–∞" –≤–º–µ—Å—Ç–æ "–º–∞–∫—Å" ‚Üí —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–π –∫–∞–∫ "–º–∞–∫—Å"
   - "–æ—Ä–∞–Ω–∂–µ–≤—ã–π" ‚Üí —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–π –∫–∞–∫ "orange"
   - "—Å–∏–º" ‚Üí —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–π –∫–∞–∫ "sim"
   - –ù–µ–±–æ–ª—å—à–∏–µ –æ–ø–µ—á–∞—Ç–∫–∏ –≤ —Å–ª–æ–≤–∞—Ö ‚Üí –∏—Å–ø—Ä–∞–≤–ª—è–π –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
   
   ‚ùå –ó–ê–ü–†–ï–©–ï–ù–û:
   - "16" ‚Üí [] (–ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤)
   - "15" ‚Üí [] (–ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤)
   - "14" –∏–ª–∏ —Å—Ç–∞—Ä—à–µ ‚Üí [] (–ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤)
   - Samsung/Xiaomi/–¥—Ä—É–≥–∏–µ –±—Ä–µ–Ω–¥—ã ‚Üí [] (–ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤)

2. –ü–ê–ú–Ø–¢–¨:
   - –ï—Å–ª–∏ –ù–ï —É–∫–∞–∑–∞–Ω–∞ ‚Üí –∏—Å–ø–æ–ª—å–∑—É–π –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é (256GB –¥–ª—è –≤—Å–µ—Ö)
   - –î–æ—Å—Ç—É–ø–Ω–æ: 256GB, 512GB, 1TB, 2TB

3. –¶–í–ï–¢ (–ö–†–ò–¢–ò–ß–ù–û):
   –°–æ–ø–æ—Å—Ç–∞–≤–ª—è–π —Å–æ–∫—Ä–∞—â–µ–Ω–∏—è/–ø–µ—Ä–µ–≤–æ–¥ —Å –¢–û–ß–ù–´–ú–ò –Ω–∞–∑–≤–∞–Ω–∏—è–º–∏:
   
   –î–ª—è iPhone 17:
   - "—Å–∏–Ω–∏–π/blue/–≥–æ–ª—É–±–æ–π/–º–∏—Å—Ç" ‚Üí "Mist Blue"
   - "–±–µ–ª—ã–π/white" ‚Üí "White"
   - "—á–µ—Ä–Ω—ã–π/black" ‚Üí "Black"
   - "–∑–µ–ª–µ–Ω—ã–π/sage/—Å–µ–π–¥–∂" ‚Üí "Sage"
   - "—Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–π/lavender/–ª–∞–≤–∞–Ω–¥–∞" ‚Üí "Lavender"
   
   –î–ª—è iPhone 17 Pro/Pro Max:
   - "–æ—Ä–∞–Ω–∂–µ–≤—ã–π/orange/–∫–æ—Å–º–∏–∫" ‚Üí "Cosmic Orange"
   - "—Å–∏–Ω–∏–π/blue/–¥–∏–ø/deep" ‚Üí "Deep Blue"
   - "—Å–µ—Ä–µ–±—Ä–æ/silver/—Å–µ—Ä–µ–±—Ä—è–Ω—ã–π" ‚Üí "Silver"
   
   –î–ª—è iPhone 17 Air –∏–ª–∏ Iphone Air:
   - "–±–µ–ª—ã–π/white/cloud" ‚Üí "Cloud White"
   - "–∑–æ–ª–æ—Ç–æ–π/gold" ‚Üí "Light Gold"
   - "—Å–∏–Ω–∏–π/blue/sky" ‚Üí "Sky Blue"
   - "—á–µ—Ä–Ω—ã–π/black/space" ‚Üí "Space Black"
   
   ‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ù–û: –ï—Å–ª–∏ —Ü–≤–µ—Ç –ù–ï —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –¥–ª—è –º–æ–¥–µ–ª–∏ ‚Üí –≤–µ—Ä–Ω–∏ [] (–ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤)
   –ù–ï –ø–æ–¥–±–∏—Ä–∞–π –ø–æ—Ö–æ–∂–∏–µ —Ü–≤–µ—Ç–∞! –¢–æ–ª—å–∫–æ —Ç–æ—á–Ω—ã–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è –∏–∑ —Å–ø–∏—Å–∫–∞ –≤—ã—à–µ –¥–ª—è –∫–∞–∂–¥–æ–π –º–æ–¥–µ–ª–∏!

4. SIM:
   - –ï—Å–ª–∏ –ù–ï —É–∫–∞–∑–∞–Ω–æ ‚Üí "1Sim" (–∫—Ä–æ–º–µ iPhone Air ‚Üí "eSim")
   - –í–∞—Ä–∏–∞–Ω—Ç—ã: "1Sim", "2Sim", "eSim"
   - "–±–µ–∑ —Å–∏–º/–±–µ–∑ sim/no sim" ‚Üí "eSim"
   - iPhone Air –¢–û–õ–¨–ö–û "eSim"
   
   –†–ê–°–ü–û–ó–ù–ê–í–ê–ù–ò–ï SIM:
   - "sim+esim/—Å–∏–º –µ—Å–∏–º/—Å–∏–º+–µ—Å–∏–º/nano-SIM + eSim/sim" ‚Üí "1Sim"
   - "—Å–∏–º+—Å–∏–º/sim+sim" ‚Üí "2Sim"
   - "(nano-SIM –∏ eSIM)" ‚Üí "1Sim"

–ü–†–ò–ú–ï–†–´:

‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û (iPhone 17/Air):
–í—Ö–æ–¥: "17 256 —Å–∏–Ω–∏–π"
–í—ã—Ö–æ–¥: [{"original": "17 256 —Å–∏–Ω–∏–π", "normalized": "iPhone 17 256 Mist Blue 1Sim"}]

–í—Ö–æ–¥: "17 –ø—Ä–æ –º–∞–∫—Å 512 orange"
–í—ã—Ö–æ–¥: [{"original": "17 –ø—Ä–æ –º–∞–∫—Å 512 orange", "normalized": "iPhone 17 Pro Max 512 Cosmic Orange 1Sim"}]

–í—Ö–æ–¥: "17 air 256 black"
–í—ã—Ö–æ–¥: [{"original": "17 air 256 black", "normalized": "iPhone Air 256 Space Black eSim"}]

–í—Ö–æ–¥: "17 256 black sim+esim"
–í—ã—Ö–æ–¥: [{"original": "17 256 black sim+esim", "normalized": "iPhone 17 256 Black 1Sim"}]

–í—Ö–æ–¥: "17 –ø—Ä–æ 512 —Å–∏–Ω–∏–π —Å–∏–º+—Å–∏–º"
–í—ã—Ö–æ–¥: [{"original": "17 –ø—Ä–æ 512 —Å–∏–Ω–∏–π —Å–∏–º+—Å–∏–º", "normalized": "iPhone 17 Pro 512 Deep Blue 2Sim"}]

–í—Ö–æ–¥: "17 —Äro 256 black" (—Å –æ–ø–µ—á–∞—Ç–∫–æ–π)
–í—ã—Ö–æ–¥: [{"original": "17 —Äro 256 black", "normalized": "iPhone 17 Pro 256 Black 1Sim"}]

–í—Ö–æ–¥: "16 pro max 256 natural\n17 Pro Max 256 Silver 1—Å–∏–º"
–í—ã—Ö–æ–¥: [
  {"original": "16 pro max 256 natural", "normalized": ""},
  {"original": "17 Pro Max 256 Silver 1—Å–∏–º", "normalized": "iPhone 17 Pro Max 256 Silver 1Sim"}
]

–í—Ö–æ–¥: "samsung galaxy s24\n17 air 256 black"
–í—ã—Ö–æ–¥: [
  {"original": "samsung galaxy s24", "normalized": ""},
  {"original": "17 air 256 black", "normalized": "iPhone Air 256 Space Black eSim"}
]

‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û:
–í—Ö–æ–¥: "16 pro max 256 desert"
–í—ã—Ö–æ–¥: []

–í—Ö–æ–¥: "17 Pro 256 –±–µ–ª—ã–π –±–µ–∑ —Å–∏–º"
–í—ã—Ö–æ–¥: []
–ü—Ä–∏—á–∏–Ω–∞: –ë–µ–ª–æ–≥–æ —Ü–≤–µ—Ç–∞ –Ω–µ—Ç —É iPhone 17 Pro

–í–ê–ñ–ù–û:
- –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–π –¢–û–õ–¨–ö–û iPhone 17, iPhone 17 Pro, iPhone 17 Pro Max, iPhone Air
- "17 air" = "iPhone Air" (—ç—Ç–æ –û–î–ù–ê –º–æ–¥–µ–ª—å, –∞ –Ω–µ –¥–≤–µ!)
- –í—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –º–æ–¥–µ–ª–∏ (16, 15, 14 –∏ —Å—Ç–∞—Ä—à–µ) ‚Üí –≤–æ–∑–≤—Ä–∞—â–∞–π []
- –ö–†–ò–¢–ò–ß–ù–û: –ò—Å–ø–æ–ª—å–∑—É–π –¢–û–õ–¨–ö–û —Ü–≤–µ—Ç–∞ –∏–∑ —Å–ø–∏—Å–∫–∞ –¥–ª—è –ö–û–ù–ö–†–ï–¢–ù–û–ô –º–æ–¥–µ–ª–∏
- –ï—Å–ª–∏ —Ü–≤–µ—Ç –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –¥–ª—è –º–æ–¥–µ–ª–∏ ‚Üí –≤–æ–∑–≤—Ä–∞—â–∞–π [] (–ù–ï –ø–æ–¥–±–∏—Ä–∞–π –ø–æ—Ö–æ–∂–∏–π!)
- –ù–ï –≤—ã–¥—É–º—ã–≤–∞–π –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏
- –ü—Ä–æ–≤–µ—Ä—è–π –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å SIM –¥–ª—è –º–æ–¥–µ–ª–∏ (Air —Ç–æ–ª—å–∫–æ eSim)
- –ù–ï Apple –±—Ä–µ–Ω–¥—ã (Samsung, Xiaomi –∏ —Ç.–¥.) ‚Üí –≤–æ–∑–≤—Ä–∞—â–∞–π []

–ü–û–ú–ù–ò: –í–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û JSON –º–∞—Å—Å–∏–≤! –ù–∏–∫–∞–∫–∏—Ö –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤, –æ–±—ä—è—Å–Ω–µ–Ω–∏–π –∏–ª–∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞!`;
            
            const requestBody = {
                model: "deepseek/deepseek-chat",  // DeepSeek: –¥–µ—à–µ–≤–∞—è –∏ –±—ã—Å—Ç—Ä–∞—è –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ –¥–ª—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∑–∞–¥–∞—á
                messages: [
                    {
                        role: "system",
                        content: systemPrompt
                    },
                    {
                        role: "user",
                        content: message
                    }
                ],
                max_tokens: 300,  // –ï—â–µ –±–æ–ª—å—à–µ —É–º–µ–Ω—å—à–µ–Ω–æ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –∑–∞—Ü–∏–∫–ª–∏–≤–∞–Ω–∏—è
                temperature: 0.3,  // –£–≤–µ–ª–∏—á–µ–Ω–æ –¥–ª—è —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏—è –æ—Ç–≤–µ—Ç–æ–≤
            };
            
            const response = await fetch(endpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${this.apiKey}`
                },
                body: JSON.stringify(requestBody)
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`AIML API error: ${response.status} - ${errorText}`);
            }

            const data = await response.json();
            let responseText = data.choices?.[0]?.message?.content || '';
            
            console.log(`üîÑ –û—Ç–≤–µ—Ç –æ—Ç AIML API: ${responseText}`);
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã (–ø–æ–≤—Ç–æ—Ä—è—é—â–∏–µ—Å—è —Å–∏–º–≤–æ–ª—ã –∏–ª–∏ —Ñ—Ä–∞–∑—ã)
            if (responseText.length > 200) {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ –ø–æ–≤—Ç–æ—Ä—è—é—â–∏–µ—Å—è —Å–∏–º–≤–æ–ª—ã
                if (/^(.)\1{50,}$/.test(responseText)) {
                    console.error(`‚ùå –ü–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç –æ—Ç API: –ø–æ–≤—Ç–æ—Ä—è—é—â–∏–µ—Å—è —Å–∏–º–≤–æ–ª—ã "${responseText[0]}"`);
                    return {
                        success: false,
                        error: `API –≤–µ—Ä–Ω—É–ª –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç: –ø–æ–≤—Ç–æ—Ä—è—é—â–∏–µ—Å—è —Å–∏–º–≤–æ–ª—ã`
                    };
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ –ø–æ–≤—Ç–æ—Ä—è—é—â–∏–µ—Å—è —Ñ—Ä–∞–∑—ã (–±–æ–ª–µ–µ 5 –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π –ø–æ–¥—Ä—è–¥)
                const lines = responseText.split('\n');
                let repeatCount = 0;
                let lastLine = '';
                for (const line of lines) {
                    if (line.trim() === lastLine && line.trim() !== '') {
                        repeatCount++;
                        if (repeatCount > 5) {
                            console.error(`‚ùå –ü–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç –æ—Ç API: –ø–æ–≤—Ç–æ—Ä—è—é—â–∏–µ—Å—è —Ñ—Ä–∞–∑—ã "${line.trim()}"`);
                            return {
                                success: false,
                                error: `API –≤–µ—Ä–Ω—É–ª –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç: –ø–æ–≤—Ç–æ—Ä—è—é—â–∏–µ—Å—è —Ñ—Ä–∞–∑—ã`
                            };
                        }
                    } else {
                        repeatCount = 0;
                        lastLine = line.trim();
                    }
                }
            }
            // –û—á–∏—â–∞–µ–º –æ—Ç markdown —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –ª–∏—à–Ω–µ–≥–æ —Ç–µ–∫—Å—Ç–∞
            responseText = responseText.trim();
            
            // –£–±–∏—Ä–∞–µ–º markdown –±–ª–æ–∫–∏
            if (responseText.startsWith('```json')) {
                responseText = responseText.replace(/^```json\s*/, '').replace(/\s*```$/, '');
            } else if (responseText.startsWith('```')) {
                responseText = responseText.replace(/^```\s*/, '').replace(/\s*```$/, '');
            }
            
            // –ò—â–µ–º JSON –º–∞—Å—Å–∏–≤ –≤ –æ—Ç–≤–µ—Ç–µ (–º–æ–∂–µ—Ç –±—ã—Ç—å –≤ –Ω–∞—á–∞–ª–µ)
            const jsonMatch = responseText.match(/^(\[.*?\])/s);
            if (jsonMatch) {
                responseText = jsonMatch[1];
                console.log(`üîç –ò–∑–≤–ª–µ—á–µ–Ω JSON –∏–∑ –æ—Ç–≤–µ—Ç–∞: ${responseText}`);
            }
            
            responseText = responseText.trim();
            
            // –ü—ã—Ç–∞–µ–º—Å—è —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å JSON –æ—Ç–≤–µ—Ç
            let parsedProducts = null;
            try {
                parsedProducts = JSON.parse(responseText);
            } catch (e) {
                console.warn('‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON:', e.message);
            }
            
            // –õ–æ–≥–∏—Ä—É–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ —Ç–æ–∫–µ–Ω–æ–≤
            if (data.usage) {
                console.log(`üìä –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤: prompt=${data.usage.prompt_tokens}, completion=${data.usage.completion_tokens}, total=${data.usage.total_tokens}`);
            }

            return {
                success: true,
                data: data,
                text: responseText,
                products: parsedProducts,
                usage: data.usage
            };
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ AIML API:', error.message);
            return {
                success: false,
                error: error.message
            };
        }
    }
}

/**
 * –§–∞–±—Ä–∏—á–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —ç–∫–∑–µ–º–ø–ª—è—Ä–∞ —Å–µ—Ä–≤–∏—Å–∞
 */
export function getAimlApiService(config) {
    return new AimlApiService(config);
}

